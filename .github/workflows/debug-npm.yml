name: Debug NPM Authentication

on:
  workflow_dispatch:
    inputs:
      debug_type:
        description: 'Type of debugging to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - auth
          - packages
          - publish

jobs:
  debug:
    name: Debug NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Configure npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
          echo "=== NPM Configuration Step ==="
          echo "Created .npmrc file with token"
          echo "Token length in environment: ${#NPM_TOKEN}"
          echo "Contents of .npmrc:"
          cat ~/.npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install Dependencies
        run: bun install

      - name: Check TEST Secret
        run: |
          echo "=== TEST Secret Check ==="
          if [ -z "$TEST" ]; then
            echo "❌ TEST secret is empty or not set"
            exit 1
          else
            echo "✅ TEST secret exists"
            echo "Value: $TEST"
          fi
        env:
          TEST: ${{ secrets.TEST }}

      - name: Check NPM Token Secret
        run: |
          echo "=== NPM Token Secret Check ==="
          if [ -z "$NPM_TOKEN" ]; then
            echo "❌ NPM_TOKEN secret is empty or not set"
            echo "Please set the NPM_TOKEN secret in your repository settings"
            echo "Go to: Settings → Secrets and variables → Actions"
            exit 1
          else
            echo "✅ NPM_TOKEN secret exists"
            echo "Token length: ${#NPM_TOKEN}"
            if [ ${#NPM_TOKEN} -eq 0 ]; then
              echo "❌ NPM_TOKEN secret is empty"
              echo "Please update the NPM_TOKEN secret with a valid npm token"
              exit 1
            else
              echo "✅ NPM_TOKEN secret has content"
            fi
          fi
          
          echo "=== Environment Variables Check ==="
          echo "NPM_TOKEN environment variable exists: $([ -n "$NPM_TOKEN" ] && echo "Yes" || echo "No")"
          echo "NPM_CONFIG_TOKEN environment variable exists: $([ -n "$NPM_CONFIG_TOKEN" ] && echo "Yes" || echo "No")"
          
          echo "=== .npmrc File Check ==="
          if [ -f ~/.npmrc ]; then
            echo "✅ .npmrc file exists"
            echo "Contents of .npmrc:"
            cat ~/.npmrc
          else
            echo "❌ .npmrc file does not exist"
          fi
          
          echo "=== Testing Token Format ==="
          # Check if token looks like a valid npm token (should be base64-like)
          if [[ "$NPM_TOKEN" =~ ^[A-Za-z0-9+/=]+$ ]]; then
            echo "✅ Token format looks valid (base64-like)"
          else
            echo "❌ Token format may be invalid"
            echo "Token should be base64-like characters only"
          fi

      - name: Debug NPM Authentication
        if: inputs.debug_type == 'all' || inputs.debug_type == 'auth'
        run: |
          echo "=== NPM Authentication Debug ==="
          echo "Checking npm whoami..."
          npm whoami || echo "npm whoami failed"
          
          echo "=== Checking npm config ==="
          npm config list
          
          echo "=== Checking npm token permissions ==="
          echo "Token starts with: ${NPM_TOKEN:0:10}..."
          echo "Token length: ${#NPM_TOKEN}"
          
          echo "=== Testing npm token with curl ==="
          curl -H "Authorization: Bearer ${NPM_TOKEN}" \
               -H "Content-Type: application/json" \
               "https://registry.npmjs.org/-/npm/v1/user" | jq '.name, .orgs' || echo "Token test failed"
          
          echo "=== Testing npm token with curl (verbose) ==="
          curl -v -H "Authorization: Bearer ${NPM_TOKEN}" \
               -H "Content-Type: application/json" \
               "https://registry.npmjs.org/-/npm/v1/user" 2>&1 | head -20 || echo "Verbose token test failed"
          
          echo "=== Testing npm whoami with verbose output ==="
          npm whoami --verbose || echo "npm whoami verbose failed"
          
          echo "=== Checking current user's organizations ==="
          npm org ls || echo "npm org ls failed"
          
          echo "=== Checking specific organization access ==="
          npm org ls cjkihl || echo "npm org ls cjkihl failed"

      - name: Debug Package Configuration
        if: inputs.debug_type == 'all' || inputs.debug_type == 'packages'
        run: |
          echo "=== Package Configuration Debug ==="
          echo "Root package.json:"
          cat package.json | jq '.name, .version, .publishConfig' || echo "Failed to read root package.json"
          
          echo "=== Checking workspace packages ==="
          for pkg in packages/*/package.json; do
            if [ -f "$pkg" ]; then
              echo "Package: $pkg"
              cat "$pkg" | jq '.name, .version, .publishConfig' || echo "Failed to read $pkg"
              echo "---"
            fi
          done
          
          echo "=== Checking registry access ==="
          echo "Testing access to @cjkihl scope..."
          npm access ls-packages || echo "npm access ls-packages failed"
          
          echo "=== Checking package access in organization ==="
          npm access ls-packages @cjkihl || echo "npm access ls-packages @cjkihl failed"
          
          echo "=== Checking if @cjkihl scope exists ==="
          curl -s "https://registry.npmjs.org/@cjkihl" | jq '.error // "Scope exists"' || echo "Failed to check scope"

      - name: Debug Publish Process
        if: inputs.debug_type == 'all' || inputs.debug_type == 'publish'
        run: |
          echo "=== Publish Process Debug ==="
          echo "Building packages..."
          bun run build
          
          echo "=== Testing npm publish dry-run ==="
          cd packages/create-exports
          npm publish --dry-run || echo "Dry-run failed"
          cd ../..
          
          echo "=== Testing changeset publish dry-run ==="
          bun run changeset publish --dry-run || echo "Changeset dry-run failed"

      - name: Generate Debug Summary
        run: |
          echo "## 🔍 NPM Debug Summary" >> $GITHUB_STEP_SUMMARY
          echo "### Debug Type: ${{ inputs.debug_type }}" >> $GITHUB_STEP_SUMMARY
          echo "### Timestamp: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues to Check:" >> $GITHUB_STEP_SUMMARY
          echo "1. **NPM Token Permissions**: Ensure token has publish access to @cjkihl organization" >> $GITHUB_STEP_SUMMARY
          echo "2. **Token Expiration**: Check if the token has expired" >> $GITHUB_STEP_SUMMARY
          echo "3. **Organization Access**: Verify token belongs to account with @cjkihl access" >> $GITHUB_STEP_SUMMARY
          echo "4. **Package Configuration**: Check package.json files for correct scope and version" >> $GITHUB_STEP_SUMMARY
          echo "5. **Registry Configuration**: Ensure npm is configured for the correct registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Review the debug output above" >> $GITHUB_STEP_SUMMARY
          echo "- Generate new npm token if needed: https://www.npmjs.com/settings/tokens" >> $GITHUB_STEP_SUMMARY
          echo "- Check organization settings: https://www.npmjs.com/settings/cjkihl/packages" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }} 